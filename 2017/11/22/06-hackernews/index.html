<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Персонализация новостной ленты Hacker News</title>
  <meta name="description" content="В этой работе вашей задачей является написание простого персонализированного новостного агрегатора.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://dementiy.github.io/2017/11/22/06-hackernews/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Ein Blog für freie Geister" href="https://dementiy.github.io/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Персонализация новостной ленты Hacker News">
  <meta name="twitter:description" content="В этой работе вашей задачей является написание простого персонализированного новостного агрегатора.">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Ein Blog für freie Geister</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/practice/">Py&Go Practice</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/Dementiy/">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Персонализация новостной ленты Hacker News</h1>
    
    <p class="post-meta"><time datetime="2017-11-22T00:00:00+03:00" itemprop="datePublished">Nov 22, 2017</time> • 
  
  
    
      <a href="/categories/python/">python</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
      <a href="/categories/golang/">golang</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/web/">web</a>,
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/datascience/">datascience</a>,
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
      <a href="/categories/%D0%BF%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B8/">практики</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>В этой работе вашей задачей является написание простого персонализированного новостного агрегатора.</p>

<p>Для выполнения этого задания вам потребуется собирать и размечать новости из одного или нескольких источников. В качестве поясняющего примера будем использовать социально-новостной сайт <a href="https://news.ycombinator.com">Hacker News</a>.</p>

<h3 id="сбор-данных">Сбор данных</h3>

<p>В предыдущих работах вы уже сталкивались с модулем <code class="highlighter-rouge">requests</code>, который позволяет отправлять запросы по HTTP-протоколу.
Вспомним, что есть два распространенных типа запросов: <code class="highlighter-rouge">GET</code> и <code class="highlighter-rouge">POST</code> (в действительности их гораздо <a href="https://ru.wikipedia.org/wiki/HTTP#.D0.9C.D0.B5.D1.82.D0.BE.D0.B4.D1.8B">больше</a>). 
В запросе типа <strong>GET</strong> информация, передаваемая серверу, расположена в ссылке, которую в случае использования веб-браузера вы можете видеть в адресной строке. 
Например, если вы перейдёте по адресу <a href="https://translate.google.com/?hl=ru#en/ru/python">https://translate.google.com/?hl=ru#en/ru/python</a>, то тем самым вы запросите у сервиса Google Translate перевод слова <em>python</em> с английского языка на русский (параметры запроса указываются после символа <code class="highlighter-rouge">?</code>).
<strong>POST</strong>-запрос используется в случаях отправки каких-либо форм (авторизация на сайте), больших объемов данных, загрузки файлов на сервер. В таком случае параметры запроса не будут отображаться в адресной строке, а будут расположены в теле запроса. Подробнее о структуре http-запросов можно узнать <a href="https://ru.wikipedia.org/wiki/HTTP#.D0.A1.D1.82.D1.80.D1.83.D0.BA.D1.82.D1.83.D1.80.D0.B0_.D0.BF.D1.80.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.BB.D0.B0">здесь</a></p>

<p>Мы пока будем использовать запросы только типа <code class="highlighter-rouge">GET</code>.</p>

<p>Давайте выполним два разных <strong>GET</strong>-запроса к новостному сайту:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">requests</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://news.ycombinator.com/newest"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
<span class="mi">200</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://news.ycombinator.com/abrakadabra"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
<span class="mi">404</span> 
</code></pre></div></div>

<blockquote>
  <p><strong>Замечание</strong>: если у вас не установлен модуль <code class="highlighter-rouge">requests</code>, то вы можете установить его командой <code class="highlighter-rouge">pip install requests</code> или <code class="highlighter-rouge">python -m pip install requests</code>.</p>
</blockquote>

<p>Первый запрос был выполнен успешно, о чем говорит значение <code class="highlighter-rouge">True</code> свойства <code class="highlighter-rouge">r.ok</code> и значение <code class="highlighter-rouge">200</code> свойства <code class="highlighter-rouge">r.status_code</code>. Возвращаемый код запроса (status_code) может содержать много полезной информации о доступности или расположении запрошенного ресурса, о состоянии сервера или возникших в процессе выполнения запроса ошибках. Подробнее о кодах ответов и их значениях можно узнать <a href="https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2_%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F_HTTP#.D0.9E.D0.B1.D0.B7.D0.BE.D1.80.D0.BD.D1.8B.D0.B9_.D1.81.D0.BF.D0.B8.D1.81.D0.BE.D0.BA">здесь</a></p>

<p>Второй запрос был выполнен к несуществующей странице, что привело к ошибке 404 - <em>Не найдено</em>.</p>

<p>Доступ к содержимому страницы можно получить с помощью атрибута <code class="highlighter-rouge">text</code> (для примера выведены первые 100 символов):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
<span class="s">'&lt;html op="newest"&gt;&lt;head&gt;&lt;meta name="referrer" content="origin"&gt;&lt;meta name="viewport" content="width='</span>
</code></pre></div></div>

<p>Как вы видите, это простая HTML-страница, из которой нам нужно извлечь интересующую нас информацию, а именно:</p>
<ul>
  <li>заголовок новости;</li>
  <li>автора новости;</li>
  <li>ссылку на новость;</li>
  <li>количество комментариев;</li>
  <li>количество “лайков”, которое набрала статья.</li>
</ul>

<p>Например, в следующей новости:
<img src="/assets/images/06-hn/hn1.png" alt="" /></p>

<ul>
  <li><strong>заголовок</strong> - Show HN: Pydb – a lightweight database with Python syntax queries, using ZeroMQ;</li>
  <li><strong>автор</strong> - asrp;</li>
  <li><strong>ссылка</strong> - https://github.com;</li>
  <li><strong>количество комментариев</strong> - 11;</li>
  <li><strong>количество “лайков”</strong> - 63.</li>
</ul>

<p>Для извлечения данных с веб-страниц существует множество разных модулей. Проблема с HTML в том, что большинство браузеров ведет себя “прощающе” относительно страниц, написанных не по стандартам HTML (в чем вы могли убедиться выполняя лабораторную работу №5). Впрочем, обработка даже не полностью корректного HTML-кода не так сложна, если под рукой есть подходящие инструменты. Мы будем пользоваться модулем <code class="highlighter-rouge">Beautiful Soup 4</code>.</p>

<blockquote>
  <p><strong>Замечание</strong>: если у вас не установлен модуль <code class="highlighter-rouge">bs4</code>, то вы можете установить его командой <code class="highlighter-rouge">pip install bs4</code> или <code class="highlighter-rouge">python -m pip install bs4</code>.</p>
</blockquote>

<p>Для использования <code class="highlighter-rouge">Beautiful Soup</code> нужно передать текст веб-страницы (в виде одной строки) функции <code class="highlighter-rouge">BeautifulSoup</code>. Чтобы он не “ругался”, также следует указывать название парсера (той программы, которая осуществляет обработку HTML). С целью совместимости я использую <code class="highlighter-rouge">html.parser</code> (он входит в пакет Python и не требует дополнительной установки), но вы можете также попробовать использовать <code class="highlighter-rouge">html5lib</code>, если он у вас установлен.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'html.parser'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">page</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">op</span><span class="o">=</span><span class="s">"newest"</span><span class="o">&gt;&lt;</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">meta</span> <span class="n">content</span><span class="o">=</span><span class="s">"origin"</span> <span class="n">name</span><span class="o">=</span><span class="s">"referrer"</span><span class="o">&gt;&lt;</span><span class="n">meta</span> <span class="n">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scal</span><span class="err">
</span><span class="s">e=1.0"</span> <span class="n">name</span><span class="o">=</span><span class="s">"viewport"</span><span class="o">&gt;&lt;</span><span class="n">link</span> <span class="n">href</span><span class="o">=</span><span class="s">"news.css?5kjS59ufyw5qyqpjcavc"</span> <span class="n">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="nb">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">link</span> <span class="n">href</span><span class="o">=</span><span class="s">"favicon.ico"</span> <span class="n">rel</span><span class="o">=</span><span class="s">"shortcut icon"</span><span class="o">&gt;</span>
<span class="o">...</span>
</code></pre></div></div>

<p>Перменная <code class="highlighter-rouge">page</code> представялет собой не просто строковое содержимое HTML-страницы. Это объект, который позволяет в удобной форме обращаться к HTML-тегам.
Например, мы можем обратиться к тегу <code class="highlighter-rouge">head</code>, а внутри него к тегу <code class="highlighter-rouge">title</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">title</span>
<span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">New</span> <span class="n">Links</span> <span class="o">|</span> <span class="n">Hacker</span> <span class="n">News</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span>
<span class="s">'New Links | Hacker News'</span>
</code></pre></div></div>

<p>Для лучшего понимания структуры HTML-страницы следует воспользоваться веб-инспектором, который есть в большинстве современных браузеров.</p>

<p><img src="/assets/images/06-hn/hn2.png" alt="" /></p>

<p>Если вы посмотрите на структуру HTML-страницы, то сможете заметить, что есть внешняя таблица, которая включает в себя еще три таблицы: заголовок, новостную ленту (которая, в свою очередь, также состоит из множества строк) и подложку (см. рисунок ниже).</p>

<p><img src="/assets/images/06-hn/hn3.png" alt="" /></p>

<p>Возникает вопрос: <em>как обратиться к внутренним таблицам?</em>. Если мы дважды обратимся к атрибуту <code class="highlighter-rouge">table</code>, то получим заголовок:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">table</span>
<span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s">"0"</span> <span class="n">cellpadding</span><span class="o">=</span><span class="s">"0"</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s">"0"</span> <span class="n">style</span><span class="o">=</span><span class="s">"padding:2px"</span> <span class="n">width</span><span class="o">=</span><span class="s">"100</span><span class="si">%</span><span class="s">"</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;&lt;</span><span class="n">td</span> <span class="n">style</span><span class="o">=</span><span class="s">"width:18px;p</span><span class="err">
</span><span class="s">adding-right:4px"</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"http://www.ycombinator.com"</span><span class="o">&gt;&lt;</span><span class="n">img</span> <span class="n">height</span><span class="o">=</span><span class="s">"18"</span> <span class="n">src</span><span class="o">=</span><span class="s">"y18.gif"</span> <span class="n">style</span><span class="o">=</span><span class="s">"border:1px white </span><span class="err">
</span><span class="s">solid;"</span> <span class="n">width</span><span class="o">=</span><span class="s">"18"</span><span class="o">/&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">td</span> <span class="n">style</span><span class="o">=</span><span class="s">"line-height:12pt; height:10px;"</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">"pagetop"</span><span class="o">&gt;&lt;</span><span class="n">b</span> <span class="n">class</span><span class="o">=</span><span class="s">"hnname"</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"news"</span><span class="o">&gt;</span><span class="n">Hacker</span> <span class="n">News</span><span class="o">&lt;</span>
<span class="o">/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">"topsel"</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"newest"</span><span class="o">&gt;</span><span class="n">new</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"newcomments"</span><span class="o">&gt;</span><span class="n">comments</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"show"</span><span class="o">&gt;</span><span class="n">sho</span>
<span class="n">w</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"ask"</span><span class="o">&gt;</span><span class="n">ask</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"jobs"</span><span class="o">&gt;</span><span class="n">jobs</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"submit"</span><span class="o">&gt;</span><span class="n">submit</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="n">td</span> <span class="n">style</span><span class="o">=</span><span class="s">"t</span><span class="err">
</span><span class="s">ext-align:right;padding-right:4px;"</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">"pagetop"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"login?goto=newest"</span><span class="o">&gt;</span><span class="n">login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>У объекта <code class="highlighter-rouge">page</code> (помимо атрибутов) есть функции, одной из которых является <code class="highlighter-rouge">findAll</code>, позволяющая найти несколько элементов с одинаковыми тегами:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">tbl_list</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'table'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl_list</span><span class="p">)</span>
<span class="mi">3</span>
</code></pre></div></div>

<p>Соответственно, нулевой элемент списка <code class="highlighter-rouge">tbl_list</code> это таблица с заголовком, первый элемент списка - таблица с новостями, а второй элемент списка - подложка.</p>

<p>На текущий момент вашей задачей является написать две функции <code class="highlighter-rouge">extract_news()</code> и <code class="highlighter-rouge">extract_next_page()</code>, для корректной работы функции <code class="highlighter-rouge">get_news()</code>, которая в качестве аргументов принимает <code class="highlighter-rouge">url</code> и <code class="highlighter-rouge">n_pages</code> (число страниц, с которых необходимо собрать новости), а возвращает список словарей, где каждый словарь представляет собой запись об одной новости (пример вывода смотрите ниже):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">news_list</span> <span class="o">=</span> <span class="n">get_news</span><span class="p">(</span><span class="s">"https://news.ycombinator.com/newest"</span><span class="p">,</span> <span class="n">n_pages</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Collecting</span> <span class="n">data</span> <span class="k">from</span> <span class="n">page</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">news</span><span class="o">.</span><span class="n">ycombinator</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">newest</span>
<span class="n">Collecting</span> <span class="n">data</span> <span class="k">from</span> <span class="n">page</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">news</span><span class="o">.</span><span class="n">ycombinator</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">newest</span><span class="err">?</span><span class="nb">next</span><span class="o">=</span><span class="mi">15852221</span><span class="o">&amp;</span><span class="n">n</span><span class="o">=</span><span class="mi">31</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pp</span><span class="p">(</span><span class="n">news_list</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
<span class="p">[{</span><span class="s">'author'</span><span class="p">:</span> <span class="s">'evo_9'</span><span class="p">,</span>
  <span class="s">'comments'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">'points'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">'title'</span><span class="p">:</span> <span class="s">'Daily Action – Sign Up to Join the Resistance'</span><span class="p">,</span>
  <span class="s">'url'</span><span class="p">:</span> <span class="s">'https://dailyaction.org/'</span><span class="p">},</span>
 <span class="p">{</span><span class="s">'author'</span><span class="p">:</span> <span class="s">'azuajef'</span><span class="p">,</span>
  <span class="s">'comments'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">'points'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">'title'</span><span class="p">:</span> <span class="s">'Immigration Ban Blocks Travelers at Airports Around Globe'</span><span class="p">,</span>
  <span class="s">'url'</span><span class="p">:</span> <span class="s">'https://www.nytimes.com/2017/01/28/us/refugees-detained-at-us-airports-prompting-legal-challenges-to</span><span class="err">
</span><span class="s">-trumps-immigration-order.html?_r=0'</span><span class="p">},</span>
 <span class="p">{</span><span class="s">'author'</span><span class="p">:</span> <span class="s">'ColinCochrane'</span><span class="p">,</span>
  <span class="s">'comments'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">'points'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="s">'title'</span><span class="p">:</span> <span class="s">'Green card holders included in Trump ban: Homeland Security'</span><span class="p">,</span>
  <span class="s">'url'</span><span class="p">:</span> <span class="s">'http://mobile.reuters.com/article/idUSKBN15C0KX'</span><span class="p">}]</span>
</code></pre></div></div>

<h3 id="сохранение-данных-в-sqlite">Сохранение данных в sqlite</h3>

<p>Собираемые данные нужно где-то хранить. Мы будем использовать для хранения <a href="https://ru.wikipedia.org/wiki/SQLite">SQLite</a> - компактную встраиваемую реляционную базу данных. В стандартной библиотеке языка Python есть модуль <a href="https://docs.python.org/3/library/sqlite3.html">sqlite3</a>, который предоставляет интерфейс для работы с SQLite. Этот модуль требует знания языка SQL, поэтому мы воспользуемся другой технологией, которая называется ORM.</p>

<p>ORM (англ. object-relational mapping, рус. объектно-реляционное отображение) — технология программирования, которая связывает базы данных с концепциями объектно-ориентированных языков программирования, создавая “виртуальную объектную базу данных”.</p>

<p><code class="highlighter-rouge">SQLAlchemy</code> — библиотека на языке Python для работы с <a href="https://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D0%B0%D1%8F\_%D0%B1%D0%B0%D0%B7%D0%B0_%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85">реляционными</a> СУБД с применением технологии ORM. Использлуется для синхронизации объектов Python и записей реляционной базы данных. SQLAlchemy позволяет описывать структуры баз данных и способы взаимодействия с ними на языке Python без использования SQL.</p>

<p>Каждая таблица описывается классом, который должен наследоваться от базового класса, создаваемого функцией <code class="highlighter-rouge">sqlalchemy.ext.declarative.declarative_base()</code>.
В рассматриваемом нами примере будет только один класс <code class="highlighter-rouge">News</code> с следующими атрибутами: заголовок, автор, ссылка, количество комментариев и число лайков.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">"sqlite:///news.db"</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">News</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">"news"</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>Обратите внимание на поле <code class="highlighter-rouge">label</code>, оно нам понадобится в разделе “<em>Разметка данных</em>”.</p>
</blockquote>

<p>Функция <code class="highlighter-rouge">sqlalchemy.create_engine()</code> создает новый экземпляр класса <code class="highlighter-rouge">sqlalchemy.engine.Engine</code>, который отвечает за подключение к базе данных.</p>

<p>Что касается создаваемой сессии, то вот небольшая выдержка о назначении сессиий из официальной документации:</p>
<blockquote>
  <p>In the most general sense, the Session establishes all conversations with the database and represents a “holding zone” for all the objects which you’ve loaded or associated with it during its lifespan. It provides the entrypoint to acquire a Query object, which sends queries to the database using the Session object’s current database connection, populating result rows into objects that are then stored in the Session, inside a structure called the Identity Map - a data structure that maintains unique copies of each object, where “unique” means “only one object with a particular primary key”.</p>

  <p>The Session begins in an essentially stateless form. Once queries are issued or other objects are persisted with it, it requests a connection resource from an Engine that is associated either with the Session itself or with the mapped Table objects being operated upon. This connection represents an ongoing transaction, which remains in effect until the Session is instructed to commit or roll back its pending state.</p>

  <p>All changes to objects maintained by a Session are tracked - before the database is queried again or before the current transaction is committed, it flushes all pending changes to the database. This is known as the Unit of Work pattern.</p>

  <p>When using a Session, it’s important to note that the objects which are associated with it are proxy objects to the transaction being held by the Session - there are a variety of events that will cause objects to re-access the database in order to keep synchronized. It is possible to “detach” objects from a Session, and to continue using them, though this practice has its caveats. It’s intended that usually, you’d re-associate detached objects with another Session when you want to work with them again, so that they can resume their normal task of representing database state.</p>
</blockquote>

<p>Более подробно о сессиях можно прочитать <a href="http://docs.sqlalchemy.org/en/latest/orm/session_basics.html">тут</a>.</p>

<p>Далее приведен пример создания объекта и сохранения его в БД:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">session</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">news</span> <span class="o">=</span> <span class="n">News</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'Lab 7'</span><span class="p">,</span> 
                <span class="n">author</span><span class="o">=</span><span class="s">'dementiy'</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="s">'https://dementiy.gitbooks.io/-python/content/lab7.html'</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">points</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
<span class="o">&gt;&gt;&gt;</span> <span class="n">news</span><span class="o">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">news</span><span class="o">.</span><span class="n">title</span>
<span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">Lab</span> <span class="mi">7</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">news</span><span class="o">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">news</span><span class="o">.</span><span class="n">title</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Lab</span> <span class="mi">7</span><span class="p">)</span>
</code></pre></div></div>

<p>Обратите внимание, что идентификатор объекта <code class="highlighter-rouge">id</code> содержит значение <code class="highlighter-rouge">None</code> до тех пор, пока мы не сделаем коммит этого объекта в БД с помощью метода <code class="highlighter-rouge">commit()</code></p>

<p>На текущий момент вашей задачей является сохранение не менее 1000 записей с новостного сайта в БД (на каждой странице по 30 новостей). Просмотреть содержимое файла <code class="highlighter-rouge">news.db</code> можно с помощью программы <a href="http://sqlitebrowser.org">DB Browser for SQLite</a>:</p>

<p><img src="/assets/images/06-hn/hn4.png" alt="" /></p>

<h3 id="разметка-данных">Разметка данных</h3>

<p>Как разметить имеющиеся данные? Давайте создадим простую HTML-страницу, на которой будем выводить список неразмеченных новостей, а рядом с каждой новостью будет несколько кнопок со следующими метками:</p>
<ul>
  <li>“<em>Интересно</em>” эта новость вам показалась интересной, и вы ее прочитали;</li>
  <li>“<em>Не интересно</em>” - эта новость вас не интересует;</li>
  <li>“<em>Возможно прочитаю</em>” - вы сомневаетесь - интересна вам эта новость или нет.</li>
</ul>

<blockquote>
  <p>Меток может быть больше. Кроме того мы можем использовать численное значение для оценки нашего отношения к новости, например, от 0 до 5.</p>
</blockquote>

<p>По нажатию на кнопку должно происходить добавление метки в БД к соответствующей новости и удаления новости из списка неразмеченных новостей, так как мы ее уже разметили.</p>

<p>Для создания такой веб-страницы воспользуемся простым и популярным веб-фреймворком <a href="https://bottlepy.org/docs/dev/">bottle</a>.</p>

<p>Давайте рассмотрим простой пример из документации к этому фреймворку:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">template</span>

<span class="nd">@route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/hello/&lt;name&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Stranger"</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s">'hello_template'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- hello_template.tpl --&gt;</span>
<span class="nt">&lt;b&gt;</span>Hello {{name}}<span class="nt">&lt;/b&gt;</span>
</code></pre></div></div>

<p>Функция <code class="highlighter-rouge">run</code> запускает веб-сервер по адресу <code class="highlighter-rouge">localhost:8080</code> (см. скриншоты ниже), обрабатывающий запросы до тех пор, пока вы его не остановите комбинацией <code class="highlighter-rouge">Ctrl+С</code>.</p>

<p><img src="/assets/images/06-hn/hn5.png" alt="" /></p>

<p><img src="/assets/images/06-hn/hn6.png" alt="" /></p>

<p><code class="highlighter-rouge">route</code> это функция-декоратор, которая отвечает за маршрутизацию и связывает адрес ресурса (веб-страницы) с функцией, которая должна быть вызвана при обращении к этому ресурсу.
В нашем примере функция <code class="highlighter-rouge">index</code> отвечает за два разных маршрута: <code class="highlighter-rouge">/</code> и <code class="highlighter-rouge">/hello/&lt;name&gt;</code>. Второй маршрут является динамическим, так как он соответствует не одному ресурсу, а целому множеству разных ресурсов: <code class="highlighter-rouge">/hello/dementiy</code>, <code class="highlighter-rouge">/hello/alice</code>, <code class="highlighter-rouge">/hello/bob</code> и т.д.
Шаблон (wildcard) заключается в угловые скобки <code class="highlighter-rouge">&lt;</code> и <code class="highlighter-rouge">&gt;</code>, а имя аргумента функции должно совпадать с именем, указанным в шаблоне (в нашем случае это <code class="highlighter-rouge">name</code>).</p>

<p>В <code class="highlighter-rouge">bottle</code> реализован механизм шаблонов, предназначенный для генерации веб-страниц. Для начала работы с шаблонизатором достаточно воспользоваться функцией <code class="highlighter-rouge">template</code>, которая в качестве первого аргумента принимает имя файла, содержащего текст шаблона (в нашем случае это <code class="highlighter-rouge">hello_template.tpl</code>). Затем следует список необязательных именованных аргументов, которые нужно передать шаблонизатору (в нашем примере это <code class="highlighter-rouge">name</code>).</p>

<p>Вернемся к нашему примеру. Напишем функцию, которая будет отвечать за маршрут <code class="highlighter-rouge">news</code> и выводить список неразмеченных новостей.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@route</span><span class="p">(</span><span class="s">'/news'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">news_list</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">session</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">News</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">News</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s">'news_template'</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- news_template.tpl --&gt;</span>
<span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">1</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>Title<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Author<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>#Likes<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>#Comments<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th</span> <span class="na">colspan=</span><span class="s">"3"</span><span class="nt">&gt;</span>Label<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    %for row in rows:
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{row.url}}"</span><span class="nt">&gt;</span>{{row.title}}<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{row.author}}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{row.points}}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{row.comments}}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/add_label/?label=good&amp;id={{row.id}}"</span><span class="nt">&gt;</span>Интересно<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/add_label/?label=maybe&amp;id={{row.id}}"</span><span class="nt">&gt;</span>Возможно<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/add_label/?label=never&amp;id={{row.id}}"</span><span class="nt">&gt;</span>Не интересно<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    %end
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div>

<p>Пример таблицы:
<img src="/assets/images/06-hn/hn7.png" alt="" /></p>

<p>Обратите внимание на запрос к БД: 
<code class="highlighter-rouge">s.query(News).filter(News.label == None).all()</code></p>
<ol>
  <li>мы обращаемся к таблице <code class="highlighter-rouge">News</code> с помощью <code class="highlighter-rouge">query(News)</code></li>
  <li>фильтруем записи. Нам нужны только те, которые не имеют метки: <code class="highlighter-rouge">filter(News.label == None)</code></li>
  <li>все полученные через <code class="highlighter-rouge">all()</code> записи передаем в шаблон</li>
</ol>

<p>В шаблоне мы формируем таблицу со списком неразмеченных новостей. Вы можете заметить, что в шаблоне допустимо использовать управляющие конструкции, такие как цикл <code class="highlighter-rouge">for</code> (<code class="highlighter-rouge">end</code> указывает на завершение тела цикла).</p>

<p>И последнее на что стоит обратить внимание: у нас есть три ссылки “<em>Интересно</em>”, “<em>Не интересно</em>” и “<em>Возможно</em>”. Переход по каждой из которых должен обрабатываться функцией, связанной с маршрутом <code class="highlighter-rouge">add_label</code>. Также происходит передача двух параметров <code class="highlighter-rouge">label</code> (нашей метки, со значениями <code class="highlighter-rouge">good</code>, <code class="highlighter-rouge">maybe</code>, <code class="highlighter-rouge">never</code>) и идентификатора новости <code class="highlighter-rouge">id</code> (вспомним, что каждая новость имеет уникальный числовой идентификатор, который она получает при добавлении в БД).</p>

<p>Вашей задачей является написание функции, которая бы добавляла метку к указанной новости и затем возвращала бы нас на страницу <code class="highlighter-rouge">news</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">redirect</span>

<span class="nd">@route</span><span class="p">(</span><span class="s">'/add_label'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_label</span><span class="p">():</span>
    <span class="c"># 1. Получить значения параметров label и id из GET-запроса</span>
    <span class="c"># 2. Получить запись из БД с соответствующим id (такая запись только одна!)</span>
    <span class="c"># 3. Изменить значение метки записи на значение label</span>
    <span class="c"># 4. Сохранить результат в БД</span>
    <span class="n">redirect</span><span class="p">(</span><span class="s">'/news'</span><span class="p">)</span>
</code></pre></div></div>

<p>Также напишите функцию, которая бы добавляла свежие новости в БД:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@route</span><span class="p">(</span><span class="s">'/update_news'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_news</span><span class="p">():</span>
    <span class="c"># 1. Получить данные с новостного сайта</span>
    <span class="c"># 2. Проверить, каких новостей еще нет в БД. Будем считать,</span>
    <span class="c">#    что каждая новость может быть уникально идентифицирована</span>
    <span class="c">#    по совокупности двух значений: заголовка и автора</span>
    <span class="c"># 3. Сохранить в БД те новости, которых там нет</span>
    <span class="n">redirect</span><span class="p">(</span><span class="s">'/news'</span><span class="p">)</span>
</code></pre></div></div>

<p>Также, добавьте в конец шаблона следующую строчку: <code class="highlighter-rouge">&lt;a href="/update_news"&gt;I Wanna more HACKER NEWS!&lt;/a&gt;</code>.</p>

<blockquote>
  <p>В одной из последующих работ вы напишете web scraper, который будет автоматически собирать новые новости.</p>
</blockquote>

<h3 id="классификация-данных">Классификация данных</h3>

<script type="text/javascript" async="" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<p>В этом разделе вашей задачей является написание простого классификатора, который бы выводил неразмеченные новости в следующем порядке: сначала идут интересные для нас новости, затем те, которые мы бы возможно прочитали, и в конце  - неинтересные новости.</p>

<p>Итак, у нас есть корпус, состоящий из размеченных и неразмеченных документов (новостей). Возникает два вопроса: “<em>Каким образом каждой свежей новости присвоить одну из меток (классов)?</em>” и “<em>Как оценить нашу классификацию?</em>”.</p>

<p>Для более качественной классификации мы будем использовать <strong>наивный байесовский классификатор</strong>. Если вы не знакомы с теоремой Байеса, то можете прочитать исчерпывающее объяснение от <a href="http://yudkowsky.net/rational/bayes">Юдковски</a> (есть перевод и на русский язык). Также, для пояснения работы наивного байесовского классификатора я буду ссылаться на статью в <a href="https://en.wikipedia.org/wiki/Naive_Bayes_classifier">Википедии</a>.</p>

<p>Итак, вопрос на который мы отвечаем: “Какова вероятность, что документ <script type="math/tex">D</script> принадлежит классу <script type="math/tex">C</script>?” или в более строгой записи: чему равно <script type="math/tex">P(D \mid C)</script>? Документом <script type="math/tex">D</script> у нас является новость, а классом <script type="math/tex">C</script> - одна из трех возможных меток: <em>“Интересно”</em>, <em>“Не интересно”</em>, <em>“Возможно”</em>.</p>

<p>Документ представляется множеством независимых слов (это лишь предположение, которого мы придерживаемся. В действительности слова не являются независимыми, например, слово “Петербург” имеет более высокую вероятность идти в паре со словом “Санкт”), где вероятность того, что <script type="math/tex">i</script>-ое слово данного документа принадлежит классу <script type="math/tex">C</script> равна <script type="math/tex">P(w_i \mid C)</script>. Таким образом, вероятность для данного документа и класса <script type="math/tex">C</script> равна:</p>

<script type="math/tex; mode=display">P(D|C) = \prod_{i} P(w_i|C)</script>

<p>По теореме Байеса получим:</p>

<script type="math/tex; mode=display">P(C|D) = \frac{P(C)P(D|C)}{P(D)}</script>

<p>Можно заметить, что знаменатель не зависит от <script type="math/tex">C</script>, поэтому получим:</p>

<script type="math/tex; mode=display">P(C|D) = P(C)P(D|C) = P(C)\prod_{i}P(w_i|C)</script>

<blockquote>
  <p>Хотя с точки зрения теории вероятностей эта формула неверная, так как сумма вероятностей не будет равна 1, но с точки зрения работы классификатора она нас полностью устраивает.</p>
</blockquote>

<p>Вы можете догадаться, что если появится слово, которое мы раньше не встречали, то <script type="math/tex">\prod_{i}P(w_i \mid C) = 0</script>, поэтому на практике берут логарифм:</p>

<script type="math/tex; mode=display">P(C|D) = \ln P(C) + \sum_i \ln P(w_i|C)</script>

<p>Итак, наша итоговая модель будет выглядеть следующим образом:</p>

<script type="math/tex; mode=display">\hat{y} = argmax_c\Big(\ln P(C=c) + \sum_i \ln P(w_i|C = c) \Big)</script>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://dementiy.github.io/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
