<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Приложение для ведения заметок</title>
  <meta name="description" content="В этой работе вы напишите простое приложение для ведения заметок, покрывая каждую часть приложения тестами. Ваше приложение будет работать в нескольких докер-контейнерах (о которых вы вскоре узнаете). И в конце разработаете API и swagger-схему для этого приложения.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://dementiy.github.io/2017/11/22/07-elevennote/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Ein Blog für freie Geister" href="https://dementiy.github.io/feed.xml">

  <link rel="icon" type="image/x-icon" href="/favicon.ico">


  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Приложение для ведения заметок">
  <meta name="twitter:description" content="В этой работе вы напишите простое приложение для ведения заметок, покрывая каждую часть приложения тестами. Ваше приложение будет работать в нескольких докер-контейнерах (о которых вы вскоре узнает...">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-111461883-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Ein Blog für freie Geister</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/practice/">Py&Go Practice</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/Dementiy/">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Приложение для ведения заметок</h1>
    
    <p class="post-meta"><time datetime="2017-11-22T00:00:00+03:00" itemprop="datePublished">Nov 22, 2017</time> • 
  
  
    
      <a href="/categories/python/">python</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
      <a href="/categories/golang/">golang</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/web/">web</a>,
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/%D0%BF%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B8/">практики</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>В этой работе вы напишите простое приложение для ведения заметок, покрывая каждую часть приложения тестами. Ваше приложение будет работать в нескольких докер-контейнерах (о которых вы вскоре узнаете). И в конце разработаете API и swagger-схему для этого приложения.</p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Эта работа основана на <a href="https://github.com/sixfeetup/ElevenNote">замечательном руководстве</a> по Django от компании Six Feet Up.</p>
</div>

<p>Как обычно создайте новую ветку разработки, папку для вашего проекта <code class="highlighter-rouge">elevennote</code> и виртуальное окружение с именем <code class="highlighter-rouge">elevennote-env</code>, в котором установите следующие пакеты:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>pip install <span class="nv">Django</span><span class="o">==</span>2.0.1
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>pip install <span class="nv">psycopg2</span><span class="o">==</span>2.7.3.2
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>pip install python-decouple<span class="o">==</span>3.1
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>pip install <span class="nv">uWSGI</span><span class="o">==</span>2.0.15
</code></pre></div></div>

<p>Можете запустить команду <code class="highlighter-rouge">pip freeze</code> для просмотра установленных пакетов:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">elevennote</span><span class="o">-</span><span class="n">env</span><span class="p">)</span> <span class="err">$</span> <span class="n">pip</span> <span class="n">freeze</span>
<span class="n">Django</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">1</span>
<span class="n">psycopg2</span><span class="o">==</span><span class="mf">2.7</span><span class="o">.</span><span class="mf">3.2</span>
<span class="n">uWSGI</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">15</span>
<span class="n">python</span><span class="o">-</span><span class="n">decouple</span><span class="o">==</span><span class="mf">3.1</span>
<span class="n">pytz</span><span class="o">==</span><span class="mf">2017.2</span>
</code></pre></div></div>

<p>Все зависимости будем хранить в отдельном манифесте:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>mkdir requirements
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>pip freeze <span class="o">&gt;</span> requirements/base.txt
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"-r base.txt"</span> <span class="o">&gt;&gt;</span> requirements/dev.txt
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"-r base.txt"</span> <span class="o">&gt;&gt;</span> requirements/prod.txt
</code></pre></div></div>

<p>Теперь создадим новый проект с помощью команды <code class="highlighter-rouge">django-admin</code> (исходники проекта будем хранить в папке <code class="highlighter-rouge">src</code>). Обратите внимание, что имя проекта <code class="highlighter-rouge">config</code>, а все файлы проекта будут созданы в текущей рабочей директории (на что указывает <code class="highlighter-rouge">.</code>):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>mkdir src <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="nv">$_</span>
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>django-admin startproject config <span class="nb">.</span>
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span><span class="nb">ls
</span>config manage.py
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span><span class="nb">cd</span> ..
</code></pre></div></div>

<p>В результате вы должны получить следующую структуру проекта:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>elevennote/
├── requirements
│   ├── base.txt
│   ├── dev.txt
│   └── prod.txt
└── src
    ├── config
    │   ├── __init__.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    └── manage.py
</code></pre></div></div>

<p>Можете проверить, что проект запускается командой <code class="highlighter-rouge">python manage.py runserver</code> (если после запуска была создана БД <code class="highlighter-rouge">db.sqlite3</code>, а какие-то файлы закешированы <code class="highlighter-rouge">__pycache__</code>, то можете смело их удалить и добавить в <code class="highlighter-rouge">.gitignore</code>).</p>

<p>Конфигурацию нашего проекта разделим на:</p>
<ul>
  <li><code class="highlighter-rouge">base.py</code> - общая конфигурация для всех развертываний проекта;</li>
  <li><code class="highlighter-rouge">local.py</code> - конфигурация, которая используется при разработке (включенный режим откладки, дополнительные пакеты для разработки, например, <code class="highlighter-rouge">django-debug-toolbar</code>);</li>
  <li><code class="highlighter-rouge">production.py</code> - настройки, которые используются для production-сервера.</li>
</ul>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Если по каким-либо причинам приложение <code>tree</code> не найдено, <a href="https://superuser.com/a/359727" target="_blank">здесь</a> вы найдете информацию по его установке.</p>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>mkdir src/config/settings
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>mv src/config/settings.py src/config/settings/base.py
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>touch src/config/settings/__init__.py
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>touch src/config/settings/local.py
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>touch src/config/settings/production.py
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>touch src/config/settings/settings.ini
<span class="o">(</span>elevennote-env<span class="o">)</span> <span class="nv">$ </span>tree src/config
src/config
├── __init__.py
├── settings
│   ├── __init__.py
│   ├── base.py
│   ├── local.py
│   ├── production.py
│   └── settings.ini
├── urls.py
└── wsgi.py
</code></pre></div></div>

<p>Содержимое файла <code class="highlighter-rouge">config/settings/base.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">decouple</span> <span class="kn">import</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="o">*</span><span class="n">dirs</span><span class="p">):</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">'..'</span><span class="p">,</span> <span class="s">'..'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="o">*</span><span class="n">dirs</span><span class="p">))</span>


<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">root</span><span class="p">()</span>

<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s">'SECRET_KEY'</span><span class="p">)</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
<span class="p">]</span>

<span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="s">'config.urls'</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
<span class="p">]</span>

<span class="n">WSGI_APPLICATION</span> <span class="o">=</span> <span class="s">'config.wsgi.application'</span>

<span class="n">AUTH_PASSWORD_VALIDATORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
<span class="p">]</span>

<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">'/static/'</span>

<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s">'en-us'</span>
<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s">'UTC'</span>
<span class="n">USE_I18N</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">USE_L10N</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">USE_TZ</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p>Содержимое файла <code class="highlighter-rouge">configs/settings/local.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">INSTALLED_APPS</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s">'django.contrib.postgres'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.postgresql_psycopg2'</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="n">config</span><span class="p">(</span><span class="s">'DB_NAME'</span><span class="p">),</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="n">config</span><span class="p">(</span><span class="s">'DB_USER'</span><span class="p">),</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="n">config</span><span class="p">(</span><span class="s">'DB_PASSWORD'</span><span class="p">),</span>
        <span class="s">'HOST'</span><span class="p">:</span> <span class="n">config</span><span class="p">(</span><span class="s">'DB_HOST'</span><span class="p">),</span>
        <span class="s">'PORT'</span><span class="p">:</span> <span class="n">config</span><span class="p">(</span><span class="s">'DB_PORT'</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>В <code class="highlighter-rouge">config/settings/settings.ini</code> укажите секретный ключ для Django, имя БД, пользователя БД, его пароль, адрес хоста и порт, на котором будет запущена БД. Ниже представлены значения некоторых полей по умолчанию.</p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Не добавляйте <code>settings.ini</code> в ваш репозиторий, так как он содержит пароли и ключи. Чтобы случайно его не закоммитить добавьте соответствующую запись в <code>.gitignore</code>.</p>
</div>

<div class="admonition note">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Если сгенерированный <code>SECRET_KEY</code> содержит символ <code>%</code>, и при этом на этапе запуска приложения возникает ошибка парсинга - продублируйте <code>%</code> везде в ключе, где этот символ встречается.</p>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">settings</span><span class="p">]</span>
<span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">MY_SECRET_KEY</span>
<span class="n">DB_NAME</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_USER</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">DB_PASSWORD</span><span class="o">=</span>
<span class="n">DB_HOST</span><span class="o">=</span><span class="n">db</span>
<span class="n">DB_PORT</span><span class="o">=</span><span class="mi">5432</span>
</code></pre></div></div>

<p>В файле <code class="highlighter-rouge">manage.py</code> необходимо заменить имеющийся путь к конфигурации проекта на следующий:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"DJANGO_SETTINGS_MODULE"</span><span class="p">,</span> <span class="s">"config.settings.local"</span><span class="p">)</span>
</code></pre></div></div>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Для знакомства с докером можно почитать статью <a href="http://djangostars.com/blog/what-is-docker-and-how-to-use-it-with-python/">What is docker and how to use it with python</a>, а также занимательную статью в <a href="http://grishaev.me/docker">блоге</a> Ивана Гришаева. Дополнительно можете посмотреть выступление Антона Егорова с Moscow Python: <a href="https://www.youtube.com/watch?v=X2jlKUHbepY">Докеризация приложений на Python</a>.</p>
</div>

<p>Создадим docker-окружение для разработки и запуска нашего проекта. Установите докер для вашей системы (инструкции можно получить <a href="https://docs.docker.com/engine/installation/">тут</a>) и создайте <code class="highlighter-rouge">Dockerfile</code> в корне вашего проекта:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM python:3.6
ENV PYTHONUNBUFFERED 1
RUN mkdir /config
COPY requirements /config/requirements
RUN pip install <span class="nt">-r</span> /config/requirements/dev.txt
RUN mkdir /src<span class="p">;</span>
WORKDIR /src
</code></pre></div></div>

<p><strong>TODO</strong>: Пояснения к Dockerfile</p>

<p>Теперь в корне проекта создадим файл <code class="highlighter-rouge">docker-compose.yml</code>:</p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Обратите внимание на <code>sleep 5</code>. Это очень наивное решение <a href="https://8thlight.com/blog/dariusz-pasciak/2016/10/17/docker-compose-wait-for-dependencies.html">проблемы зависимостей</a> между контейнерами.</p>
</div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '3'
services:
    nginx:
        image: nginx:latest
        container_name: ng01
        ports:
            - "8000:8000"
        volumes:
            - ./deploy/nginx:/etc/nginx/conf.d
        depends_on:
            - web
    web:
        build: .
        container_name: dg01
        command: bash -c "sleep 5 &amp;&amp; python manage.py makemigrations &amp;&amp; python manage.py migrate &amp;&amp; uwsgi --ini /usr/local/etc/elevennote.ini"
        depends_on:
            - db
        volumes:
            - ./src:/src
            - ./deploy/uwsgi:/usr/local/etc/
        expose:
            - "8000"
    db:
        image: postgres:latest
        container_name: ps01
</code></pre></div></div>

<p><strong>TODO</strong>: Пояснения к docker-compose.yml</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir <span class="nt">-p</span> deploy/uwsgi
</code></pre></div></div>

<p><code class="highlighter-rouge">deploy/uwsgi/elevennote.ini</code></p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[uwsgi]</span>
<span class="py">chdir</span> <span class="p">=</span> <span class="s">/src</span>
<span class="py">module</span> <span class="p">=</span> <span class="s">config.wsgi:application</span>
<span class="py">master</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">processes</span> <span class="p">=</span> <span class="s">5</span>
<span class="py">socket</span> <span class="p">=</span> <span class="s">0.0.0.0:8000</span>
<span class="py">vacuum</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">die-on-term</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">env</span> <span class="p">=</span> <span class="s">DJANGO_SETTINGS_MODULE=config.settings.local</span>
</code></pre></div></div>

<p><strong>TODO</strong>: Пояснения к конфигурации uwsgi</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir deploy/nginx
</code></pre></div></div>

<p><code class="highlighter-rouge">deploy/nginx/elevennote.conf</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upstream web {
    ip_hash;
    server web:8000;
}

server {
    location / {
        include uwsgi_params;
        uwsgi_pass web;
    }
    listen 8000;
    server_name localhost;
}
</code></pre></div></div>

<p><strong>TODO</strong>: Пояснения к nginx</p>

<p>На текущий момент структура вашего проекта должна быть следующей:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── Dockerfile
├── deploy
│   ├── nginx
│   │   └── elevennote.conf
│   └── uwsgi
│       └── elevennote.ini
├── docker-compose.yml
├── requirements
│   ├── base.txt
│   ├── dev.txt
│   └── prod.txt
└── src
    ├── config
    │   ├── __init__.py
    │   ├── settings
    │   │   ├── __init__.py
    │   │   ├── base.py
    │   │   ├── local.py
    │   │   ├── production.py
    │   │   └── settings.ini
    │   ├── urls.py
    │   └── wsgi.py
    └── manage.py
</code></pre></div></div>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Если на данном этапе возникнет ошибка <code>UnicodeDecodeError</code>, выполните команду <code>rm -rf ~/.docker/config.json</code> для ее устранения.</p>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose build
<span class="nv">$ </span>docker-compose up
</code></pre></div></div>

<p>Теперь приложение запущено и вы можете обратиться к нему по адресу <a href="http://localhost:8000">http://localhost:8000</a>, где должны увидеть стандартное приветствие Django:</p>

<p><img src="/assets/images/07-elevennote/elevennote1.png" /></p>

<p>На текущий момент осталась одна нерешенная проблема - обработка статических файлов (css/js/и т.д.). Если пройти по адресу <a href="http://localhost:8000/admin">http://localhost:8000/admin</a>, то мы увидим форму без применения стилей:</p>

<p><img src="/assets/images/07-elevennote/elevennote2.png" /></p>

<p>Если же обработка статических файлов настроена верно, то мы должны увидеть следующую форму:</p>

<p><img src="/assets/images/07-elevennote/elevennote2_1.png" /></p>

<div class="admonition note">
  <p class="first admonition-title"><strong>Подсказка</strong></p>
  <p class="last">Если у вас пока не получается справится с этой проблемой, то вы можете найти решение в репозитории для этой работы.</p>
</div>

<p><strong>Задание</strong>: Решите обозначенную проблему путем внесения соответствующих изменений в <code class="highlighter-rouge">docker-compose.yml</code>, <code class="highlighter-rouge">deploy/nginx/elevennote.conf</code> и <code class="highlighter-rouge">src/config/settings/base.py</code>.</p>

<p>На текущий момент нам больше не нужно виртуальное окружение, так как эту часть функций, а именно изоляции окружения, на себя взял докер.</p>

<p>Создадим суперпользователя, чтобы иметь возможность заходить в панель администратора. Для этого подключимся к контейнеру:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> dg01 bash
root@67a3bcc5c881:/src# python manage.py createsuperuser
Username <span class="o">(</span>leave blank to use <span class="s1">'root'</span><span class="o">)</span>:
Email address:
Password:
Password <span class="o">(</span>again<span class="o">)</span>:
Superuser created successfully.
root@67a3bcc5c881:/src# <span class="nb">exit</span>
</code></pre></div></div>

<p>Создадим новое приложение <code class="highlighter-rouge">notes</code> (заметки) и добавим его в <code class="highlighter-rouge">INSTALLED_APPS</code>:</p>

<div class="admonition note">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Убедитесь, что в папке <code>src</code> появилась папка <code>notes</code>, в которой нужно располагать все файлы, касающиеся приложения <code>notes</code>.</p>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python manage.py startapp notes
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
    <span class="s">'notes'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Создадим первую модель <code class="highlighter-rouge">Note</code> со следующими полями:</p>
<ul>
  <li>заголовок (<code class="highlighter-rouge">title</code>) с ограничением 200 символов;</li>
  <li>текст заметки (<code class="highlighter-rouge">body</code>);</li>
  <li>и датой создания (<code class="highlighter-rouge">pub_date</code>).</li>
</ul>

<p><code class="highlighter-rouge">notes/models.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s">'date published'</span><span class="p">)</span>
</code></pre></div></div>

<p>Зарегистрируем созданную модель в панели администратора:
<code class="highlighter-rouge">notes/admin.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Note</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Note</span><span class="p">)</span>
</code></pre></div></div>

<p>И применим внесенные изменения к БД:</p>

<div class="admonition note">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Миграцию необходимо выполнять всякий раз, когда изменяется структура базы данных (добавление/удаление полей, редактирование их свойств и т.д.), но при перезапуске контейнера <code>web</code> это будет происходить автоматически.</p>
</div>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">При необходимости вы можете перезапустить контейнер <code>web</code> командой <code>docker-compose restart web</code>.</p>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python manage.py makemigrations notes
<span class="nv">$ </span>docker-compose run web python manage.py migrate
<span class="nv">$ </span>docker-compose restart web
</code></pre></div></div>

<p>Теперь откройте панель администратора <a href="http://localhost:8000/admin">http://localhost:8000/admin</a>. Вы должны увидеть новый раздел <code class="highlighter-rouge">Notes</code>, в котором вы можете создавать, редактировать и удалять заметки.</p>

<p><img src="/assets/images/07-elevennote/elevennote3.png" /></p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">На момент составления этой работы <code>django-admin-honeypot</code> не совместим с Django версии 2 (и скорее всего уже не будет). Поэтому представленный пример работает только для более ранних версий фреймворка.</p>
</div>

<p>Вы могли заметить, что путь по умолчанию для входа в панель администратора - <code class="highlighter-rouge">/admin</code>. В случае, если вы хотите предотвратить потенциальные автоматизированные атаки на ваш ресурс путем подбора логина и пароля, или же есть любые иные причины ограничить доступ к панели администратора путем изменения адреса, по которому она будет доступна, вы можете обратить внимание на модуль <a href="https://github.com/dmpayton/django-admin-honeypot">admin-honeypot</a>, который также будет вести историю попыток входа в фейковую панель администратора.</p>

<p>Этот этап не обязателен, вы можете его пропустить или вернуться к нему позже.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> dg01 bash
root@67a3bcc5c881:/src# pip install django-admin-honeypot<span class="o">==</span>1.0.0
root@67a3bcc5c881:/src# <span class="nb">exit</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
    <span class="s">'admin_honeypot'</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">]</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^admin/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'admin_honeypot.urls'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'admin_honeypot'</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^secret/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Логи попыток входа:</p>

<p><img src="/assets/images/07-elevennote/elevennote4.png" /></p>

<p>Вернемся к приложению с заметками. На текущий момент, если создать новую заметку через панель администратора, то она будет отображаться следующим образом:</p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Мы также можем переопределить метод <code>__str__</code> у модели <code>Note</code>.</p>
</div>

<p><img src="/assets/images/07-elevennote/elevennote5_1.png" /></p>

<p>Сделаем отображение заметки в панели администратора более дружелюбным, отображая название заметки и дату публикации. Дополнительно добавим поле, указываюещее на то, была ли заметка опубликована в течениии последних 24-х часов:</p>

<p><code class="highlighter-rouge">src/notes/admin.py</code></p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Узнать больше о расширении панели администратора можно в <a href="https://docs.djangoproject.com/en/2.0/ref/contrib/admin/">официальной документации</a>.</p>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">NoteAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'pub_date'</span><span class="p">,</span> <span class="s">'was_published_recently'</span><span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s">'pub_date'</span><span class="p">]</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">NoteAdmin</span><span class="p">)</span>
</code></pre></div></div>

<p>Мы ссылаемся на новый метод <code class="highlighter-rouge">was_published_recently</code>, который нужно добавить в модель <code class="highlighter-rouge">Note</code>:</p>

<p><code class="highlighter-rouge">src/notes/models.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>

<span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">was_published_recently</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">&gt;=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/images/07-elevennote/elevennote5.png" /></p>

<p>Давайте напишем наш первый тест, который будет проверять, что отложенная заметка не является недавно опубликованной:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir src/notes/tests
<span class="nv">$ </span>mv src/notes/tests.py src/notes/tests/test_models.py
<span class="nv">$ </span>touch src/notes/tests/__init__.py
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/tests/test_models.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">notes.models</span> <span class="kn">import</span> <span class="n">Note</span>

<span class="k">class</span> <span class="nc">NoteMethodTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_was_published_recently</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        was_published_recently() should return False for notes whose pub_date is in the future.
        """</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">future_note</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="n">pub_date</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">future_note</span><span class="o">.</span><span class="n">was_published_recently</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python manage.py <span class="nb">test
</span>Creating <span class="nb">test </span>database <span class="k">for </span><span class="nb">alias</span> <span class="s1">'default'</span>...
System check identified no issues <span class="o">(</span>0 silenced<span class="o">)</span><span class="nb">.</span>
F
<span class="o">======================================================================</span>
FAIL: test_was_published_recently <span class="o">(</span>notes.tests.test_models.NoteMethodTests<span class="o">)</span>
<span class="nt">----------------------------------------------------------------------</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/src/notes/tests/test_models.py"</span>, line 14, <span class="k">in </span>test_was_published_recently
    self.assertEqual<span class="o">(</span>future_note.was_published_recently<span class="o">()</span>, False<span class="o">)</span>
AssertionError: True <span class="o">!=</span> False

<span class="nt">----------------------------------------------------------------------</span>
Ran 1 <span class="nb">test </span><span class="k">in </span>0.020s

FAILED <span class="o">(</span><span class="nv">failures</span><span class="o">=</span>1<span class="o">)</span>
Destroying <span class="nb">test </span>database <span class="k">for </span><span class="nb">alias</span> <span class="s1">'default'</span>...
</code></pre></div></div>

<p>Похоже была допущена ошибка в методе <code class="highlighter-rouge">was_published_recently</code>, давайте исправим ее:</p>

<p><code class="highlighter-rouge">src/notes/models.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="k">def</span> <span class="nf">was_published_recently</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">&lt;=</span> <span class="n">now</span>
</code></pre></div></div>

<p>И снова запустим тесты:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python manage.py <span class="nb">test
</span>Creating <span class="nb">test </span>database <span class="k">for </span><span class="nb">alias</span> <span class="s1">'default'</span>...
System check identified no issues <span class="o">(</span>0 silenced<span class="o">)</span><span class="nb">.</span>
<span class="nb">.</span>
<span class="nt">----------------------------------------------------------------------</span>
Ran 1 <span class="nb">test </span><span class="k">in </span>0.006s

OK
Destroying <span class="nb">test </span>database <span class="k">for </span><span class="nb">alias</span> <span class="s1">'default'</span>...
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">path</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'notes/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'notes.urls'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'notes'</span><span class="p">)),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>touch src/notes/urls.py
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s">'notes'</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'index'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'&lt;int:note_id&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'detail'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Note</span>


<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">latest_note_list</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-pub_date'</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'latest_note_list'</span><span class="p">:</span> <span class="n">latest_note_list</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'notes/index.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">note_id</span><span class="p">):</span>
     <span class="n">note</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">note_id</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'notes/detail.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'note'</span><span class="p">:</span> <span class="n">note</span><span class="p">})</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir <span class="nt">-p</span> src/templates/notes
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'BACKEND'</span><span class="p">:</span> <span class="s">'django.template.backends.django.DjangoTemplates'</span><span class="p">,</span>
        <span class="s">'DIRS'</span><span class="p">:</span> <span class="p">[</span><span class="n">root</span><span class="p">(</span><span class="s">'templates'</span><span class="p">)],</span>
        <span class="c"># ...</span>
    <span class="p">},</span>
<span class="p">]</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/templates/notes/index.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% if latest_note_list %}
   <span class="nt">&lt;ul&gt;</span>
   {% for note in latest_note_list %}
     <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'notes:detail' note.id %}"</span><span class="nt">&gt;</span>{{ note.title }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
   {% endfor %}
   <span class="nt">&lt;/ul&gt;</span>
{% else %}
  <span class="nt">&lt;p&gt;</span>No notes available.<span class="nt">&lt;/p&gt;</span>
{% endif %}
</code></pre></div></div>

<p><code class="highlighter-rouge">src/templates/notes/detail.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>{{ note.title }}<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>{{ note.body }}<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/tests/tests_views.py</code></p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Обратите внимание на использование f-strings, которые были введены в Python 3.6.</p>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">resolve</span>

<span class="kn">from</span> <span class="nn">notes.models</span> <span class="kn">import</span> <span class="n">Note</span>
<span class="kn">from</span> <span class="nn">notes.views</span> <span class="kn">import</span> <span class="n">index</span><span class="p">,</span> <span class="n">detail</span>


<span class="k">class</span> <span class="nc">IndexTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">"Note title"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s">"Note description"</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'notes:index'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_index_view_status_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_index_url_resolves_index_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="s">'/notes/'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_index_view_contains_link_to_details_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">note_detail_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'notes:detail'</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'note_id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="n">f</span><span class="s">'href="{note_detail_url}"'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DetailTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">"Note title"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s">"Note description"</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'notes:detail'</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">'note_id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_detail_view_status_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_detail_url_resolves_detail_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="n">f</span><span class="s">'/notes/{self.note.pk}/'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python manage.py <span class="nb">test
</span>Creating <span class="nb">test </span>database <span class="k">for </span><span class="nb">alias</span> <span class="s1">'default'</span>...
System check identified no issues <span class="o">(</span>0 silenced<span class="o">)</span><span class="nb">.</span>
......
<span class="nt">----------------------------------------------------------------------</span>
Ran 6 tests <span class="k">in </span>0.117s

OK
Destroying <span class="nb">test </span>database <span class="k">for </span><span class="nb">alias</span> <span class="s1">'default'</span>...
</code></pre></div></div>

<p>Создадим новое приложением <code class="highlighter-rouge">accounts</code>, которое будет отвечать за хранение информации о пользователях. Также добавим возможность регистрации и авторизации.</p>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Не забудьте добавить созданное приложение в <code>INSTALLED_APPS</code> в файле <code>src/config/settings/base.py</code>.</p>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python manage.py startapp accounts
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/urls.py</code></p>
<div class="admonition note">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">Обратите внимание, что мы используем <code>RedirectView</code> для перенаправления запроса с <code>http://localhost:8000/</code> на <code>htpp://localhost:8000/notes/</code>.</p>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#...</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">RedirectView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># Handle the root url.</span>
    <span class="n">path</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">RedirectView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">'notes/'</span><span class="p">)),</span>

    <span class="c"># Accounts app</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'accounts.urls'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'accounts'</span><span class="p">)),</span>

    <span class="c"># Notes app</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'notes/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'notes.urls'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'notes'</span><span class="p">)),</span>

    <span class="c"># Admin</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>touch src/accounts/urls.py
</code></pre></div></div>

<p><code class="highlighter-rouge">src/accounts/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s">'accounts'</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'login/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'login'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'logout/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">logout</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'logout'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir src/templates/registration
<span class="nv">$ </span>touch src/templates/registration/login.html
</code></pre></div></div>

<p><code class="highlighter-rouge">src/templates/registration/login.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{% url 'accounts:login' %}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">accept-charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  {% csrf_token %}
  {% for field in form %}
    <span class="nt">&lt;label&gt;</span>{{ field.label }}<span class="nt">&lt;/label&gt;</span>
    {% if field.errors %}
      {{ field.errors }}
    {% endif %}
    {{ field }}
  {% endfor %}
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"next"</span> <span class="na">value=</span><span class="s">"{{ next }}"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"button small"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p><img src="/assets/images/07-elevennote/elevennote_signin_old.png" /></p>

<p>Отмечаем соответствующие страницы доступными только после авторизации добавлением декоратора <code class="highlighter-rouge">@login_required</code>:</p>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/tests/test_views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">IndexTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">"test"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"qwerty123"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">"test"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"qwerty123"</span><span class="p">)</span>
        <span class="c"># ...</span>

<span class="k">class</span> <span class="nc">DetailTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">"test"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"qwerty123"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">"test"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"qwerty123"</span><span class="p">)</span>
        <span class="c"># ...</span>
</code></pre></div></div>

<p>Далее предлагается загрузить набор стилевых компонентов <a href="https://getbootstrap.com/">bootstrap</a> и поместить их в папку со статичными файлами. Это, в свою очередь, решит обозначенную в начале работы проблему и преобразит внешний вид формы входа.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir src/static
<span class="nv">$ </span><span class="nb">cd </span>src/static
<span class="nv">$ </span>wget https://github.com/twbs/bootstrap/releases/download/v4.0.0-beta.3/bootstrap-4.0.0-beta.3-dist.zip
<span class="nv">$ </span>unzip bootstrap-4.0.0-beta.3-dist.zip <span class="nt">-d</span> bootstrap
<span class="nv">$ </span><span class="nb">cd</span> -
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">'/static/'</span>
<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="s">'/static'</span>
<span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">root</span><span class="p">(</span><span class="s">'static'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> dg01 bash
root@67a3bcc5c881:/src# pip install django-widget-tweaks
root@67a3bcc5c881:/src# <span class="nb">exit</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"django-widget-tweaks==1.4.1"</span> <span class="o">&gt;&gt;</span> requirements/base.txt
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
    <span class="s">'widget_tweaks'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Fix me</span>
wget https://github.com/sixfeetup/ElevenNote/raw/master/templates-ch06.zip
unzip templates-ch6.zip   <span class="c"># If prompted to replace, say (Y)es</span>
<span class="nb">cd</span> ..
</code></pre></div></div>

<p><img src="/assets/images/07-elevennote/elevennote_signin_new.png" /></p>

<p>Добавляем возможность регистрации.</p>

<p><code class="highlighter-rouge">src/accounts/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">UserCreationForm</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">FormView</span>


<span class="k">class</span> <span class="nc">RegisterView</span><span class="p">(</span><span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">'registration/register.html'</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">UserCreationForm</span>
    <span class="n">success_url</span><span class="o">=</span><span class="s">'/'</span>

    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="c">#save the new user first</span>
        <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c">#get the username and password</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'password1'</span><span class="p">]</span>

        <span class="c">#authenticate user then login</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RegisterView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/accounts/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">reverse_lazy</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">views</span> <span class="k">as</span> <span class="n">auth_views</span>

<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">RegisterView</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s">'accounts'</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'login/'</span><span class="p">,</span> <span class="n">auth_views</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'login'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'logout/'</span><span class="p">,</span> <span class="n">auth_views</span><span class="o">.</span><span class="n">logout</span><span class="p">,</span> <span class="p">{</span><span class="s">"next_page"</span> <span class="p">:</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s">'accounts:login'</span><span class="p">)},</span> <span class="n">name</span><span class="o">=</span><span class="s">'logout'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'register/'</span><span class="p">,</span> <span class="n">RegisterView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'register'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Далее настраивается адрес, на который будет осуществлен переход по факту успешной авторизации/регистрации.</p>

<p><code class="highlighter-rouge">config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="n">LOGIN_REDIRECT_URL</span> <span class="o">=</span> <span class="s">'/'</span>
</code></pre></div></div>

<p><img src="/assets/images/07-elevennote/elevennote_signup_new.png" /></p>

<p><code class="highlighter-rouge">src/templates/registration/login.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'accounts:register' %}"</span><span class="nt">&gt;</span>Create a new user<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">accounts/tests/test_views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<p>Добавим в модель заметки информацию об авторе - пользователе, создавшем ее - путем внесения внешнего ключа.</p>

<p><code class="highlighter-rouge">src/notes/models.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'notes'</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</code></pre></div></div>

<p>Как говорилось ранее, вследствие изменения структуры базы данных необходимо выполнить миграцию.</p>

<p><strong>TODO</strong>: выбор значения по умолчанию</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> dg01 bash
root@67a3bcc5c881:/src# python manage.py makemigrations
root@67a3bcc5c881:/src# python manage.py migrate
root@67a3bcc5c881:/src# <span class="nb">exit</span>
</code></pre></div></div>

<p>В выводимый список заметок добавим сортировку по убыванию даты публикации и ограничим выводимое количество (5 шт.). Позже можно убрать количественное ограничение для возможности постраничного просмотра имеющихся заметок.</p>

<p><code class="highlighter-rouge">notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">latest_note_list</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-pub_date'</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">notes/admin.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'owner'</span><span class="p">,</span> <span class="s">'pub_date'</span><span class="p">,</span> <span class="s">'was_published_recently'</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="kn">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">DetailView</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Note</span>


<span class="k">class</span> <span class="nc">NoteList</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">'notes/index.html'</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s">'latest_note_list'</span>

    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">login_required</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NoteDetail</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Note</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">'notes/detail.html'</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s">'note'</span>

    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">login_required</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteDetail</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">notes/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">NoteList</span><span class="p">,</span> <span class="n">NoteDetail</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s">'notes'</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">NoteList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'index'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'&lt;int:pk&gt;/'</span><span class="p">,</span> <span class="n">NoteDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'detail'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="admonition legend">
  <p class="first admonition-title"><strong>Замечание</strong></p>
  <p class="last">В <a href="https://github.com/sixfeetup/ElevenNote/wiki/09-Intro-to-Mixins">руководстве</a> от Six Feet Up объясняется как создать собственный миксин, который бы решал аналогичную задачу.</p>
</div>

<p><code class="highlighter-rouge">notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib.auth.mixins</span> <span class="kn">import</span> <span class="n">LoginRequiredMixin</span>


<span class="k">class</span> <span class="nc">NoteList</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="c"># ...</span>

<span class="k">class</span> <span class="nc">NoteDetail</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
    <span class="c"># ...</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">notes/forms.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Note</span>

<span class="k">class</span> <span class="nc">NoteForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Note</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'body'</span><span class="p">]</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">CreateView</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse_lazy</span>

<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">NoteForm</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">NoteCreate</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">NoteForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">'notes/form.html'</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s">'notes:index'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteCreate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">path</span><span class="p">(</span><span class="s">'new/'</span><span class="p">,</span> <span class="n">NoteCreate</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'create'</span><span class="p">),</span>
</code></pre></div></div>

<p>Добавляем шаблон формы, используемый для создания и редактирования заметок.
Убедитесь в наличии шаблона <code class="highlighter-rouge">base.html</code>, от которого ряд других шаблонов будет наследоваться.
Используемая логика: <code class="highlighter-rouge">base.html</code> реализует базовый интерфейс в виде шапки ресурса, в которой отображается имя авторизованного пользователя и кнопка выхода, в то время как наследники реализуют интерфейс отдельного модуля в блоке <code class="highlighter-rouge">content</code></p>

<p><code class="highlighter-rouge">src/templates/notes/form.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% extends "base.html" %}

{% block content %}

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{% url 'notes:create' %}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">accept-charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    {% csrf_token %}
    {% include 'includes/form.html' %}
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"next"</span> <span class="na">value=</span><span class="s">"{{ next }}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-success"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

{% endblock %}
</code></pre></div></div>

<p><img src="/assets/images/07-elevennote/elevennote_create_new.png" /></p>

<p>Добавим возможность создания новой заметки в интерфейс общего списка заметок.</p>

<p><code class="highlighter-rouge">src/templates/notes/index.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'notes:create' %}"</span><span class="nt">&gt;</span>Create a new note<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p>Добавим возможность постраничного просмотра имеющихся заметок.</p>

<p><code class="highlighter-rouge">src/template/notes/index.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% if is_paginated %}
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pagination"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"step-links"</span><span class="nt">&gt;</span>
       {% if page_obj.has_previous %}
           <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"?page={{ page_obj.previous_page_number }}"</span><span class="nt">&gt;</span>previous<span class="nt">&lt;/a&gt;</span>
       {% endif %}

       <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"current"</span><span class="nt">&gt;</span>
           Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
       <span class="nt">&lt;/span&gt;</span>

       {% if page_obj.has_next %}
          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"?page={{ page_obj.next_page_number }}"</span><span class="nt">&gt;</span>next<span class="nt">&lt;/a&gt;</span>
       {% endif %}
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/div&gt;</span>
{% endif %}
</code></pre></div></div>

<p>Пользователь должен иметь доступ только к тем заметкам, автором которых является.</p>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-pub_date'</span><span class="p">)</span>
</code></pre></div></div>

<p>Для возможности обширного редактирования заметок (функции для выделения текста, использование различных шрифтов, вставка ссылок, изображений и т. д.) предлагается к использованию модуль <a href="https://github.com/pydanny-archive/django-wysiwyg">django-wysiwyg</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> dg01 bash
root@67a3bcc5c881:/src# python <span class="nt">-m</span> pip install django-wysiwyg
root@67a3bcc5c881:/src# <span class="nb">exit</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"django-wysiwyg==0.8.0"</span> <span class="o">&gt;&gt;</span> requirements/base.txt
</code></pre></div></div>

<p><code class="highlighter-rouge">src/config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
    <span class="s">'django_wysiwyg'</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">]</span>

<span class="c">#...</span>
<span class="n">DJANGO_WYSIWYG_FLAVOR</span> <span class="o">=</span> <span class="s">'ckeditor'</span>
</code></pre></div></div>

<p>Далее нужно загрузить предпочитаемый редактор текста.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>src/static
<span class="nv">$ </span>wget https://download.cksource.com/CKEditor/CKEditor/CKEditor%204.7.2/ckeditor_4.7.2_full.zip
<span class="nv">$ </span>unzip ckeditor_4.7.2_full.zip
<span class="nv">$ </span><span class="nb">cd</span> -
</code></pre></div></div>

<p>Предотвращение неправомерного доступа.</p>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">PermissionDenied</span>

<span class="o">...</span>

<span class="c"># In NoteDetail class, override the get() method to raise an</span>
<span class="c"># error if the user tries to view another user's note.</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="nb">object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="nb">object</span><span class="o">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>

    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="nb">object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">,</span> <span class="n">UpdateView</span>

<span class="o">...</span>

<span class="k">class</span> <span class="nc">NoteUpdate</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Note</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">NoteForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">'notes/form.html'</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s">'notes:index'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
       <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteUpdate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">NoteList</span><span class="p">,</span> <span class="n">NoteDetail</span><span class="p">,</span> <span class="n">NoteCreate</span><span class="p">,</span> <span class="n">NoteUpdate</span>
<span class="c"># ...</span>

<span class="n">path</span><span class="p">(</span><span class="s">'&lt;int:pk&gt;/edit/'</span><span class="p">,</span> <span class="n">NoteUpdate</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'update'</span><span class="p">),</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/templates/notes/form.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% if object %}
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{% url 'notes:update' object.pk %}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">accept-charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
{% else %}
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{% url 'notes:create' %}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">accept-charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
{% endif %}
</code></pre></div></div>

<p><code class="highlighter-rouge">src/templates/notes/detail.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'notes:update' note.id %}"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/templates/notes/detail.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>
   <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'notes:update' note.id %}"</span><span class="nt">&gt;</span>{{ note.title }}<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
   {{ note.body | safe }}
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/mixins.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Note</span>


<span class="k">class</span> <span class="nc">NoteMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
       <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

       <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
          <span class="s">'notes'</span><span class="p">:</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-pub_date'</span><span class="p">),</span>
       <span class="p">})</span>

       <span class="k">return</span> <span class="n">context</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">NoteCreate</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">NoteMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">NoteUpdate</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">NoteMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>

    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="nb">object</span><span class="o">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PermissionDenied</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteUpdate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="nb">object</span><span class="o">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PermissionDenied</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteUpdate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget https://github.com/sixfeetup/ElevenNote/raw/master/templates-ch16.zip
<span class="nv">$ </span>unzip templates-ch16.zip
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>static
wget https://github.com/sixfeetup/ElevenNote/raw/master/static-elevennote-ch16.zip
unzip static-elevennote-ch16.zip
<span class="nb">cd</span> ..
</code></pre></div></div>

<p><img src="/assets/images/07-elevennote/elevennote_new_styles.png" /></p>

<p><code class="highlighter-rouge">src/notes/mixins.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">check_user_or_403</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="s">""" Issue a 403 if the current user is no the same as the `user` param. """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ListView</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">,</span> <span class="n">DeleteView</span>
<span class="p">)</span>
<span class="c"># ...</span>

<span class="k">class</span> <span class="nc">NoteDelete</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">NoteMixin</span><span class="p">,</span> <span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Note</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s">'notes:index'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_user_or_403</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="nb">object</span><span class="o">.</span><span class="n">owner</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NoteDelete</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/urls.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">NoteList</span><span class="p">,</span> <span class="n">NoteDetail</span><span class="p">,</span> <span class="n">NoteCreate</span><span class="p">,</span> <span class="n">NoteUpdate</span><span class="p">,</span> <span class="n">NoteDelete</span>
<span class="c"># ...</span>
<span class="n">path</span><span class="p">(</span><span class="s">'&lt;int:pk&gt;/delete/'</span><span class="p">,</span> <span class="n">NoteDelete</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'delete'</span><span class="p">),</span>
</code></pre></div></div>

<p>Предоставление возможности удаления заметки.</p>

<p><code class="highlighter-rouge">src/templates/base.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="na">href=</span><span class="s">'{% static "font-awesome/css/font-awesome.css" %}'</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">src/templates/notes/form.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% if object %}
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{% url 'notes:delete' object.pk %}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">id=</span><span class="s">"delete-note-form"</span><span class="nt">&gt;</span>
    {% csrf_token %}
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-outline-dark"</span> <span class="na">id=</span><span class="s">"delete-note"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fa fa-trash"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
    <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/form&gt;</span>
{% endif %}
</code></pre></div></div>

<p><code class="highlighter-rouge">src/notes/views.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'notes:update'</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'pk'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="nb">object</span><span class="o">.</span><span class="n">pk</span>
    <span class="p">})</span>
</code></pre></div></div>

<p><strong>Задание:</strong></p>
<ol>
  <li>Добавьте возможность указывать теги у каждой заметки (можете использовать <a href="https://bootstrap-tagsinput.github.io/bootstrap-tagsinput/examples/">Bootstrap Tags Input</a> для отображения и управления тегами на стороне клиента, см. скриншот ниже). При нажатии на тег должен выводиться список только тех заметок, у которых указан этот тег.</li>
  <li>Продолжая предыдущее задание добавьте возможность поиска не только по тегам, но и по названию заметок.</li>
  <li>Добавьте возможность расшаривания заметок.</li>
  <li>Регистрация нового пользователя должна происходить по email. Пользователю на электронную почту должна приходить ссылка с подтверждением регистрации.</li>
</ol>

<p><img src="/assets/images/07-elevennote/elevennote8.png" /></p>

<h3 id="continuous-integration-с-circleci">Continuous Integration с CircleCI</h3>

<h3 id="добавляем-api-с-помощью-drf">Добавляем API с помощью DRF</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip install djangorestframework
<span class="nv">$ </span>python manage.py api
</code></pre></div></div>

<p><code class="highlighter-rouge">config/settings/base.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
    <span class="s">'rest_framework'</span><span class="p">,</span>
    <span class="c"># ...</span>
    <span class="s">'api'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">api/base/serializers.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">notes.models</span> <span class="kn">import</span> <span class="n">Note</span>

<span class="k">class</span> <span class="nc">NoteSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Note</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">,</span> <span class="s">'body'</span><span class="p">,</span> <span class="s">'pub_date'</span><span class="p">)</span>
</code></pre></div></div>

  </div>

  
    <div class="post-comments" itemprop="comment">
      

    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://dementiy.github.io/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
